---
title: "Dynam jobevolutie kaartjes"
output: 
  html_notebook: 
    code_folding: show
    theme: lumen
---

```{r, message=FALSE, warning=FALSE}
library(here)
library(readxl)
library(dplyr)
library(BelgiumMaps.StatBel)
library(sf)
library(tmap)
library(leaflet)
library(leaflet.minicharts)
library(htmltools)
```

```{r}
dynam.prov = read_excel(
    '20180425_dynam_be_jobdata_origineel.xlsx', 'Sheet2',
    skip = 1,  col_names = c(
      'province_lbl', 'province_nis_code', 
      'absoluut_bruto_toename', 'absoluut_bruto_afname', 'absoluut_netto', 'delme',
      'delmetoo', 'bruto_toename_pct', 'bruto_afname_pct', 'netto_pct')) %>%
  select(-delme, -delmetoo)
```

```{r}
dynam.prov
```


```{r, warning=FALSE}
dynam.prov = dynam.prov %>%
  mutate(
    netto_pct = netto_pct*100,
    absoluut_bruto_afname = absoluut_bruto_afname*-1)
```

```{r}
data('BE_ADMIN_PROVINCE') 
data("BE_ADMIN_REGION")

# convert to simple features dataset-structure
provinces = st_as_sf(BE_ADMIN_PROVINCE) 
regions = st_as_sf(BE_ADMIN_REGION) 

# Spatial object for Brussels-region is not included in provences, add from region
provinces = rbind(
  provinces %>% select(CD_PROV_REFNIS, TX_PROV_DESCR_NL),
  regions %>%
    filter(TX_RGN_DESCR_NL == "Brussels Hoofdstedelijk Gewest") %>%
    mutate(CD_RGN_REFNIS = '04000') %>%
    select(
      CD_PROV_REFNIS = CD_RGN_REFNIS,
      TX_PROV_DESCR_NL = TX_RGN_DESCR_NL))
```

```{r}
provinces = provinces %>%
  mutate(CD_PROV_REFNIS = as.character(CD_PROV_REFNIS)) %>%
  left_join(dynam.prov, c('CD_PROV_REFNIS' = 'province_nis_code'))
```


```{r}
pal <- colorBin("Greens", domain = dynam.prov$netto_pct)
```

```{r, warning=FALSE}
# get centroid coordinates for each province to plot barchart there
provinces_coords = st_coordinates(st_centroid(provinces))
```

```{r}
d.abs = dynam.prov %>%
  select(
    'Jobgroei' = absoluut_bruto_toename,
    'Jobverlies' = absoluut_bruto_afname,
    'Netto jobevolutie' = absoluut_netto)
```


```{r results="asis", echo=FALSE}
cat("
<style>
.leaflet-container {
    background: #FFF;
}
</style>
")
```

```{r}
m.prov = leaflet(provinces, width = '100%') %>% 
  # add grey arrondissement polygons w/t white border
  addPolygons(
    weight = 2,
    opacity = 1,
    dashArray = "3",
    fillColor = ~pal(netto_pct), color = 'white') %>% 
  addLegend(pal = pal, values = ~absoluut_netto, opacity = 0.7,
            title = 'Netto jobevolutie (%)',
  position = "bottomright")

colors <- c("#7cae00", "#f8766d", "#c77cff")
m.prov = m.prov %>%
  addMinicharts(
    provinces_coords[,1], provinces_coords[,2],
    chartdata = d.abs,
    colorPalette = colors,
    width = 45, height = 45)

map_title <- tags$div(
   HTML('<b>Bruto en netto jobevolutie per provincie, 2017-2018 (<a href="https://dynamresearch.be/">DynaM</a>)</b>')
 )  

m.prov = m.prov %>% 
  addControl(map_title, position = "bottomleft")

m.prov

```

